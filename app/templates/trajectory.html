{% extends 'shared/dashboard.html' %}
{% block content %}
<!-- Content Begin -->
    <div id="chart-area">
        <div class="row">
            <div class="col-md-4"></div>
            <div class="col-md-4">
                <div class="embed-responsive embed-responsive-4by3">
                    <object id="monitor" class="embed-responsive-item">
                    </object>
                </div>
            </div>
            <div class="col-md-4"></div>
        </div>
        <hr>
        <div id="gallery" style="position:relative; overflow-x: auto;float:left; min-width: 100%; height: 400px">

        </div>
    </div>

    <script type="text/javascript" src="/static/resource/testData.js"></script>
    <script type="text/javascript" src="/static/javascripts/manage/tmpl.min.js"></script>
    {% raw %}
    <script type="text/blueimp-tmpl" id="pic">
        <div class="out" style="width:240px; height:160px; margin:10px;float:left; display:inline">
            <div style="width:100%; height:100%; position:relative">
                <img src={%#o.src%} style="position:absolute; left:0; top:0; width:100%; height:100% "></img>
                <canvas style="position:absolute; left:0; top:0; width:100%; height:100%"></canvas>
            </div>
        </div>
    </script>

    {% endraw %}
    <script>
        //17:33:25.379
        //17:34:59.53
        var player;
        var test;
        var loop;
        var offset=1407922405379;
        var elements=function() {
            player=$f('monitor', resource_url+"flowPlayer/flowPlayer-3.2.18.swf", {
                clip: {
                    autoPlay: true,
                    onBeforeFinish: function(){
                        return false;
                    },
                    url: '/static/resource/front_desk.flv'
                },
                plugins: {
                    controls: {
                        url: resource_url+'flowPlayer/flowplayer.controls-3.2.16.swf'
                    }
                }
            });
            function query(start,end){
                var rv=[];
                for (var i=0; i<data.length; i++){
                    if(data[i].frameid>start && data[i].frameid<end){
                        data[i].ts=new Date(data[i].ts);
                        rv.push(data[i]);
                    }
                }
                return rv;
            }
            function draw(dom,w,h,left,top,width,height,time){
                var ctx=dom.getContext('2d');
                ctx.beginPath();
                ctx.strokeStyle='red';
                ctx.lineWidth=3;
                ctx.strokeRect(left,top,width,height);
            }
            function fileName(time){
                var year=time.getFullYear().toString();
                var month=thmTools.twoDigit(time.getMonth()+1);
                var day=thmTools.twoDigit(time.getDate());
                var hour=time.getHours().toString();
                var minute=time.getMinutes().toString();
                var second=thmTools.twoDigit(time.getSeconds());
                var milli=thmTools.truncLastZero(thmTools.threeDigit(time.getMilliseconds()));

                return year+'-'+month+'-'+day+' '+hour+'_'+minute+'_'+second+'.'+milli+'.jpeg';
            }
            function group(data){
                var rv={};
                for(var i=0; i<data.length; i++){
                    var src=fileName(data[i].ts);
                    if (rv[src]){
                        rv[src].push(data[i]);
                    }
                    else{
                        rv[src]=[];
                        rv[src].push(data[i]);
                    }
                }
                console.log(rv);
                return rv;
            }
            function append(src,data){

                var dom=document.getElementById('gallery');
                src=src.replace(' ','%20');
                var t=thmTools.parseStringToDom(tmpl('pic',{src:'/static/resource/testPic/'+src}));
                dom.insertBefore(t[0],dom.firstChild);
                //thmTools.appendDomList(dom,t);
                var canvas=$(t[0]).find('canvas')[0];
                canvas.width=640;
                canvas.height=480;
                for(var i=0; i<data.length; i++){
                    draw(canvas,640,480,data[i].x,data[i].y,data[i].w,data[i].h,data[i].ts);
                }
            }
            var hasDisplayed={};
            loop=function(){
                var time=player.getTime();
                var frameID=parseInt(time/113*1150);
                var queryResult=query(frameID-10,frameID);
                queryResult=group(queryResult);
                for (var pic in queryResult){
                    if(queryResult.hasOwnProperty(pic)){
                        if (!hasDisplayed[queryResult[pic][0].frameid]){
                            append(pic,queryResult[pic]);
                            hasDisplayed[queryResult[pic][0].frameid]=true;
                        }
                    }
                }
            };
            //Loop main
            setInterval("loop();",1000);
        };

    </script>
{% endblock %}